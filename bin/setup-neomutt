#!/bin/sh
set -eu

case ${1:-} in *help|-h)
  exec perldoc -T $0;;
esac

cd
mkdir -p sandbox

if [ ! -d sandbox/neomutt ]; then
  git clone --depth 1 https://github.com/neomutt/neomutt.git sandbox/neomutt
else
  git -C sandbox/neomutt pull
fi

cd sandbox/neomutt

case "${OSTYPE:-}" in
  darwin*)
    # Use macports' headers
    OPENSSL_PREFIX=/opt/local
    ;;
esac

./prepare -q \
 --with-mailpath=/var/spool/mail \
 --with-ssl${OPENSSL_PREFIX:+=$OPENSSL_PREFIX} \
 --with-sasl \
 --with-tokyocabinet \
 --enable-gpgme \
 --enable-imap --enable-smtp \

make -s -j3

cd ~/bin
for BIN in mutt mutt_dotlock pgpewrap; do
  ln -sf ../sandbox/neomutt/$BIN
done

:<<=cut
=head1 NAME

setup-neomutt - Clone/update and build neomutt

=head1 DESCRIPTION

Run to do the above, incl. symlinking relevant binaries in C<~/bin> to the
neomutt build.

=head1 REQUIREMENTS

=head2 Debian

  apt install autoconf links gnupg2 gpgsm urlscan libncursesw5-dev \
    libssl-dev libsasl2-dev libtokyocabinet-dev libgpgme11-dev

=cut
